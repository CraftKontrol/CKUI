<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKUI Support - TouchDesigner Troubleshooting Assistant</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="logo">CK</div>
        <div class="header-title">
            <h1>CKUI Support Assistant</h1>
            <p>TouchDesigner Troubleshooting Chatbot</p>
        </div>
    </header>

    <div class="api-key-section">
        <label for="apiKey">Mistral API Key:</label>
        <input type="password" id="apiKey" placeholder="Enter your Mistral API key..." />
        <span class="hint">
            Get your API key from <a href="https://console.mistral.ai/" target="_blank" rel="noopener noreferrer">Mistral AI Console</a>
        </span>
    </div>

    <main class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message" id="welcomeMessage">
                <h2>ðŸ‘‹ Welcome to CKUI Support</h2>
                <p>I'm here to help you troubleshoot CKUI modules for TouchDesigner.</p>
                <p>Ask me about Project Manager, library setup, configurations, and more!</p>
                <div class="quick-actions">
                    <button class="quick-action" onclick="askQuestion('How do I set up the Project Manager?')">Set up Project Manager</button>
                    <button class="quick-action" onclick="askQuestion('How do I configure libraries?')">Configure Libraries</button>
                    <button class="quick-action" onclick="askQuestion('How do I create a virtual environment?')">Create Virtual Environment</button>
                    <button class="quick-action" onclick="askQuestion('What are the CKUI dependencies?')">CKUI Dependencies</button>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    id="userInput" 
                    placeholder="Ask about CKUI modules, TouchDesigner setup, troubleshooting..." 
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    Send
                </button>
            </div>
        </div>
    </main>

    <script>
        // CKUI Knowledge Base - Context for the chatbot
        const CKUI_CONTEXT = `
You are a helpful assistant specialized in CKUI (CraftKontrol UI) modules for TouchDesigner. 
You help users troubleshoot and understand the CKUI System.

CKUI System Overview:
- CKUI is a user interface framework designed for interactive installations an performances in TouchDesigner
- It is part of the CKLib library, providing tools for building interactive experiences, reserved for Artcraft Visuals projects.
- Author: Arnaud Cassone Â© Artcraft Visuals


Wiki links:
- [base url] = https://github.com/CraftKontrol/CKUI/wiki/
- [Home](../CKUI.wiki/Home.md) - Main overview
- [Audio](../CKUI.wiki/Audio.md) - Audio system documentation
- [Content Manager](../CKUI.wiki/Content-Manager.md) - Content management features
- [Kinect Azure](../CKUI.wiki/Kinect-Azure.md) - Kinect Azure integration
- [Leap Motion](../CKUI.wiki/Leap-Motion.md) - Leap Motion sensor support
- [MultiLidarAreaBlob](../CKUI.wiki/MultiLidarAreaBlob.md) - Lidar blob detection
- [Output](../CKUI.wiki/Output.md) - Output configuration
- [Project Manager](../CKUI.wiki/ProjectManager.md) - Project management tools
- [Rendering](../CKUI.wiki/Rendering.md) - Rendering pipeline
- [Sensors](../CKUI.wiki/Sensors.md) - Sensor integration
- [Stereo Engine](../CKUI.wiki/Stereo-Engine.md) - Stereo processing
- [System](../CKUI.wiki/System.md) - System configuration
- [UI](../CKUI.wiki/Ui.md) - User interface
- [Web Logger](../CKUI.wiki/WebLogger.md) - Web logging functionality


When answering questions:
- Be concise but thorough
- Provide step-by-step instructions when appropriate
- Reference specific parameters or functions when relevant
- Reference the wiki documentation where applicable
- Suggest checking the Logger for error messages
- Recommend using the Project Manager's built-in features
`;

        let conversationHistory = [];
        let isLoading = false;

        // Auto-resize textarea
        const textarea = document.getElementById('userInput');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Load API key from sessionStorage (more secure than localStorage for sensitive data)
        const apiKeyInput = document.getElementById('apiKey');
        const savedApiKey = sessionStorage.getItem('mistralApiKey');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
        }

        // Save API key to sessionStorage when changed (clears when browser tab is closed)
        apiKeyInput.addEventListener('change', function() {
            sessionStorage.setItem('mistralApiKey', this.value);
        });

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askQuestion(question) {
            document.getElementById('userInput').value = question;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!message || isLoading) return;

            if (!apiKey) {
                showError('Please enter your Mistral API key to use the chatbot.');
                return;
            }

            // Hide welcome message
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (welcomeMsg) {
                welcomeMsg.style.display = 'none';
            }

            // Add user message to UI
            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // Show typing indicator
            showTypingIndicator();
            isLoading = true;
            document.getElementById('sendButton').disabled = true;

            try {
                const response = await callMistralAPI(apiKey, message);
                hideTypingIndicator();
                
                // Add assistant message to UI
                addMessage(response, 'assistant');
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });
            } catch (error) {
                hideTypingIndicator();
                showError(error.message);
            } finally {
                isLoading = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        async function callMistralAPI(apiKey, userMessage) {
            const messages = [
                {
                    role: 'system',
                    content: CKUI_CONTEXT
                },
                ...conversationHistory
            ];

            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'mistral-small-latest',
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                if (response.status === 401) {
                    throw new Error('Invalid API key. Please check your Mistral API key.');
                } else if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Please wait a moment and try again.');
                } else {
                    throw new Error(errorData.message || `API error: ${response.status}`);
                }
            }

            const data = await response.json();
            
            // Validate API response structure
            if (!data || !data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                throw new Error('Invalid response from API. Please try again.');
            }
            
            return data.choices[0].message.content;
        }

        function addMessage(content, role) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessage(content) {
            // First escape HTML to prevent XSS
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // Escape the content first
            let formatted = escapeHtml(content);
            
            // Then apply safe markdown-style formatting
            formatted = formatted
                // Code blocks (already escaped, safe to wrap in tags)
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Bold
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                // Line breaks
                .replace(/\n/g, '<br>');

            return formatted;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ðŸ¤–';

            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';

            typingDiv.appendChild(avatar);
            typingDiv.appendChild(indicator);
            chatMessages.appendChild(typingDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function showError(message) {
            const chatMessages = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>